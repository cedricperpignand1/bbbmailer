generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  phaseSize Int        @default(500)
  contacts  Contact[]
  campaigns Campaign[]
  createdAt DateTime   @default(now())

  // Auto Campaigns (MVP uses Category as the "list")
  autoCampaigns    AutoCampaign[]
  phoneContacts    PhoneContact[]
  autoSmsCampaigns AutoSmsCampaign[]
}

model Contact {
  id          Int      @id @default(autoincrement())
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  email       String
  firstName   String?
  phaseNumber Int
  status      String   @default("active") // active|bounced|unsubscribed|complained
  createdAt   DateTime @default(now())

  sendLogs          SendLog[]
  autoCampaignSends AutoCampaignSend[]

  @@unique([categoryId, email])
  @@index([categoryId, phaseNumber])
}

model Template {
  id        Int      @id @default(autoincrement())
  name      String
  subject   String
  html      String
  createdAt DateTime @default(now())

  campaigns Campaign[]

  // Auto Campaigns use ONE fixed template
  autoCampaigns AutoCampaign[]
}

model Campaign {
  id          Int      @id @default(autoincrement())
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  phaseNumber Int
  templateId  Int
  template    Template @relation(fields: [templateId], references: [id])
  status      String   @default("draft") // draft|queued|sending|done|paused
  createdAt   DateTime @default(now())

  logs SendLog[]

  @@index([categoryId, phaseNumber])
}

model SendLog {
  id         Int      @id @default(autoincrement())
  campaignId Int
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  contactId  Int
  contact    Contact  @relation(fields: [contactId], references: [id])

  status            String    @default("queued") // queued|sent|failed
  provider          String    @default("mailgun") // mailgun|resend|ses|etc
  providerMessageId String? // Mailgun's id, Resend's id, etc.
  error             String?
  sentAt            DateTime?
  meta              Json? // NEW: store { address: "..." } etc.
  createdAt         DateTime  @default(now())

  @@index([campaignId, status])
  @@index([provider])
}

/**
 * Auto Campaigns
 * - 30-day window schedule (start -> +30 days)
 * - uses a Category as the contact list (MVP)
 * - stores pasted addresses (one per line)
 * - uses ONE fixed template (Project Invite (Auto))
 */
model AutoCampaign {
  id     Int     @id @default(autoincrement())
  name   String  @default("Monthly Project Invites")
  active Boolean @default(true)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  templateId Int?
  template   Template? @relation(fields: [templateId], references: [id])

  // Inline template (Gmail-based system)
  templateSubject String  @default("")
  templateBody    String  @default("") @db.Text

  // Paste box: one address per line
  addressesText String @db.Text

  maxPerDay Int @default(45)

  // User-input schedule preferences
  dayOfMonth   Int @default(1) // 1..28 recommended
  sendHourET   Int @default(11) // 0..23
  sendMinuteET Int @default(0) // 0..59

  // 30-day drip window boundaries (ET-based schedule, stored as DateTime)
  windowStartET DateTime?
  windowEndET   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs      AutoCampaignRun[]
  sends     AutoCampaignSend[]
  dailyRuns AutoCampaignDailyRun[]

  @@index([active])
  @@index([categoryId])
  @@index([templateId])
}

model AutoCampaignRun {
  id Int @id @default(autoincrement())

  autoCampaignId Int
  autoCampaign   AutoCampaign @relation(fields: [autoCampaignId], references: [id])

  // One run per day (ET date string)
  // example: "2026-01-06"
  runDateET String

  // weekdayKey: "mon" | "tue" | "wed" | "thu" | "fri"
  weekdayKey String

  ranAt       DateTime @default(now())
  queuedCount Int      @default(0)

  // optional: link to the regular Campaign created for this run
  campaignId Int?

  @@unique([autoCampaignId, runDateET])
  @@index([autoCampaignId, weekdayKey])
}

model AutoCampaignSend {
  id Int @id @default(autoincrement())

  campaignId Int
  campaign   AutoCampaign @relation(fields: [campaignId], references: [id])

  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id])

  status      String    // SENT | FAILED
  sentAt      DateTime?
  projectUsed String    @default("")
  gmailMessageId String?
  error       String?
  createdAt   DateTime  @default(now())

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
}

model AutoCampaignDailyRun {
  id Int @id @default(autoincrement())

  campaignId Int
  campaign   AutoCampaign @relation(fields: [campaignId], references: [id])

  dateET      String // YYYY-MM-DD
  ranAt       DateTime @default(now())
  sentCount   Int      @default(0)
  failedCount Int      @default(0)

  @@unique([campaignId, dateET])
  @@index([campaignId])
}

model GmailAccount {
  id                  Int       @id @default(autoincrement())
  email               String    @unique
  refreshToken        String
  accessToken         String?
  accessTokenExpiresAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model PhoneContact {
  id         Int      @id @default(autoincrement())
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  phone       String // store E.164 if possible: +13055551212
  status      String       @default("active") // active|invalid|unsubscribed|complained
  createdAt   DateTime     @default(now())
  smsSendLogs SmsSendLog[]

  // prevent duplicates inside the same list/category
  @@unique([categoryId, phone])
  @@index([categoryId, status])
}

model AutoSmsCampaign {
  id     Int     @id @default(autoincrement())
  name   String
  active Boolean @default(true)

  // "List" is Category (same pattern as your email auto campaigns)
  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id])

  // schedule (ET)
  dayOfMonth   Int @default(1)
  sendHourET   Int @default(9)
  sendMinuteET Int @default(0)

  // Twilio from-number (E.164)
  fromNumber String @default("")

  // message template, supports {{address}}
  messageTemplate String @default("Hi â€” project starting at {{address}}. Reply STOP to opt out.")

  // addresses (one per line)
  addressesText String @default("")
  addressIndex  Int    @default(0)

  // auto-stop after N days from activation
  startAt       DateTime?
  stopAfterDays Int       @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs     AutoSmsRun[]
  sendLogs SmsSendLog[]
}

model AutoSmsRun {
  id                Int             @id @default(autoincrement())
  autoSmsCampaignId Int
  autoSmsCampaign   AutoSmsCampaign @relation(fields: [autoSmsCampaignId], references: [id])

  // prevent duplicates per month + weekday bucket
  monthKey   String
  weekdayKey Int // 0..4 (Mon..Fri)

  ranAt     DateTime @default(now())
  sentCount Int      @default(0)
  error     String?

  @@unique([autoSmsCampaignId, monthKey, weekdayKey])
  @@index([autoSmsCampaignId, ranAt])
}

model SmsSendLog {
  id                Int             @id @default(autoincrement())
  autoSmsCampaignId Int
  autoSmsCampaign   AutoSmsCampaign @relation(fields: [autoSmsCampaignId], references: [id])

  phoneContactId Int?
  phoneContact   PhoneContact? @relation(fields: [phoneContactId], references: [id])

  toPhone   String
  fromPhone String
  body      String

  status            String    @default("queued") // queued|sent|failed
  providerMessageId String?
  error             String?
  sentAt            DateTime?
  createdAt         DateTime  @default(now())

  @@index([autoSmsCampaignId, status, createdAt])
}
